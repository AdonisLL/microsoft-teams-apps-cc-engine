name: Deploy CC App

on:
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:
   # Allows you to run this workflow remotley from GitHub API 
  repository_dispatch:
    types: [deploy-api]
    inputs:
        # Change this value
        UPDATE_APIM_API:
          description: 'Boolean to update APIM API (YES,NO)'
          required: true
          default: 'YES'

# CONFIGURATION
# For help, go to https://github.com/Azure/Actions
#
# 1. Set up the following secrets in your repository:
#   AZURE_WEBAPP_PUBLISH_PROFILE
#
# 2. Change these variables for your configuration:
env:
  DOTNET_VERSION: '6.0.x'           # set this to the dot net version to use
  WEBSITE_NAME: ''                  # this is going to be filed by querying the web apps in the resource group

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:

      # Checkout the repo
      - uses: actions/checkout@master
      
      # Setup .NET Core SDK
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }} 
      
      # Run dotnet build and publish
      - name: dotnet build and publish
        run: |
          dotnet restore
          dotnet build --configuration Release
          dotnet publish -c Release -o './ccapp'
        working-directory: "source/companycommunicator/"

      # Azure Login
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Get the web app name
      - name: Azure CLI script
        uses: azure/CLI@v1
        with:
          azcliversion: 2.30.0
          inlineScript: |
            echo "WEBSITE_NAME="$(awk -F'.' '{gsub("\"", "", $1); print $1}' <<< $(az webapp list -g ${{ secrets.AZURE_RG }} --query [0].defaultHostName)) >> $GITHUB_ENV
      
      # # Get the APIM name
      # - name: Azure CLI script
      #   uses: azure/CLI@v1
      #   with:
      #     azcliversion: 2.30.0
      #     inlineScript: |
      #       echo "APIM_NAME="$(awk -F'.' '{gsub("\"", "", $1); print $1}' <<< $(az apim list -g ${{ secrets.AZURE_RG }} --query [0].name)) >> $GITHUB_ENV
      
      # Deploy to Azure Web apps
      - name: 'Run Azure webapp deploy action using publish profile credentials'
        uses: azure/webapps-deploy@v2
        with: 
          app-name: ${{ env.WEBSITE_NAME }} # Replace with your app name
          package: './source/companycommunicator/ccapp'


      # # Deploy Bicep file
      # - name: 'deploy using env vars'
      #   id: 'deployInfra'
      #   uses: azure/arm-deploy@v1
      #   with:
      #     subscriptionId: ${{ secrets.AZURE_SUBSCRIPTION }}
      #     resourceGroupName: ${{ secrets.AZURE_RG }}
      #     template: ./infra/bicep/apim-schema.bicep
      #     parameters: 
      #       appName=${{ env.WEBSITE_NAME }}
      #       apimServiceName=${{ env.APIM_NAME }}
      #     failOnStdErr: false
